name: Deploy to QA

# Shows who triggered the workflow
run-name: Deploy QA by @${{ github.actor }}

# Manual trigger only
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, qa-server]

    # Track deployment history in QA environment
    environment:
      name: QA
      # url: https://qa.site.com  # Optional: QA site URL

    # Write permission to bypass branch protection
    permissions:
      contents: write

    steps:
      - name: Checkout QA Branch
        uses: actions/checkout@v4
        with:
          ref: qa
          fetch-depth: 0
          token: ${{ secrets.BYPASS_TOKEN }}

      - name: Setup Git User (For Merge)
        run: |
          git config --global user.name "CI/CD Bot"
          git config --global user.email "bot@ci-cd.com"

      # --- STEP 1: MERGE (DEV -> QA) ---
      - name: Merge DEV into QA
        shell: powershell
        run: |
          Write-Host ">> Merging DEV into QA..." -ForegroundColor Cyan
          git fetch origin dev

          git merge origin/dev --allow-unrelated-histories --no-edit -m "ci(qa): DEV -> QA merge (version will be tagged after)"

          # Check for merge conflicts
          $conflictFiles = git diff --name-only --diff-filter=U
          if ($conflictFiles) {
            $err = "Merge conflict detected. Conflicting files: $conflictFiles"
            Write-Host "[!] MERGE CONFLICT DETECTED!" -ForegroundColor Red
            Write-Host "Conflicting files:" -ForegroundColor Yellow
            Write-Host $conflictFiles
            Write-Host "`nPlease resolve conflicts manually and try again." -ForegroundColor Yellow
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

          Write-Host "[OK] Merge Success!" -ForegroundColor Green

      # --- STEP 2: CALCULATE VERSION (after merge - package.json now available from DEV) ---
      - name: Calculate Smart Version
        shell: powershell
        run: |
          # Read version from package.json (after merge - updated version from DEV)
          $json = Get-Content 'package.json' -Raw | ConvertFrom-Json
          $appVer = $json.version

          Write-Host ">> Package Version: $appVer" -ForegroundColor Cyan

          # Find existing tags for this version
          git fetch --tags
          $prefix = "qa-v$appVer."
          $tagOutput = git tag -l "$prefix*"

          # Calculate next build number
          if ([string]::IsNullOrWhiteSpace($tagOutput)) {
            $buildNum = 1
          } else {
            $tags = $tagOutput -split "`n" | Where-Object { $_ -ne "" }
            $maxNum = 0
            foreach ($tag in $tags) {
               $num = [int]($tag -replace [regex]::Escape($prefix), "")
               if ($num -gt $maxNum) { $maxNum = $num }
            }
            $buildNum = $maxNum + 1
          }

          # Final version tag (e.g., qa-v0.1.7.1)
          $fullVer = "$prefix$buildNum"

          Write-Host ">> Next Build Number: $buildNum" -ForegroundColor Green
          Write-Host ">> Final Tag: $fullVer" -ForegroundColor Green

          echo "FULL_VERSION=$fullVer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "APP_VERSION=$appVer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # --- STEP 2b: UPDATE MERGE COMMIT AND PUSH ---
      - name: Amend Merge Commit with Version and Push
        shell: powershell
        run: |
          $runNum = "${{ github.run_number }}"
          $commitMsg = "ci(qa): DEV -> QA automated deploy [$env:FULL_VERSION] - GitHub Actions Run #$runNum"
          git commit --amend -m "$commitMsg"
          git push origin qa
          Write-Host "[OK] Pushed with version tag in commit message!" -ForegroundColor Green

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      # --- STEP 3: DEPLOY ---
      - name: Run Deploy Script
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          ./scripts/deploy.ps1 -environment "qa"
          if ($LASTEXITCODE -ne 0) {
            $err = "Deploy script failed with exit code $LASTEXITCODE. Check deployment logs above for details."
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

      # --- STEP 4: TAGGING ---
      - name: Create Git Tag
        if: success()
        shell: powershell
        run: |
          $existingTag = git tag -l $env:FULL_VERSION
          if ($existingTag) {
            Write-Host "[!] Tag $env:FULL_VERSION already exists." -ForegroundColor Yellow
            exit 0
          } else {
            git tag $env:FULL_VERSION
            git push origin $env:FULL_VERSION
            Write-Host "[OK] Tag Created and Pushed: $env:FULL_VERSION" -ForegroundColor Green
          }

      # --- STEP 5: SUMMARY ---
      - name: Add Job Summary
        if: always()
        shell: powershell
        run: |
          $status = if ("${{ job.status }}" -eq "success") { "SUCCESS" } else { "FAILED" }

          $msg = "### Deploy Summary`n"
          $msg += "* **Status:** $status`n"

          if ($env:FAILURE_REASON) {
            $msg += "* **ERROR REASON:** $env:FAILURE_REASON`n"
          }

          $msg += "* **Environment:** QA`n"
          $msg += "* **Release Tag:** $($env:FULL_VERSION -replace '^$', 'N/A - Failed before tagging')`n"
          $msg += "* **App Version:** $($env:APP_VERSION -replace '^$', 'N/A')`n"
          $msg += "* **Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm')`n"

          echo $msg | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
