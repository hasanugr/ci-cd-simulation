name: Deploy to QA

# Dynamic name for better visibility
run-name: Deploy QA by @${{ github.actor }}

# Manual trigger only, no inputs required
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    # QA Environment tracking for deployment history and status
    environment:
      name: QA
      url: http://localhost:8080/  # Local QA for testing - OPTIONAL: Uncomment and set your live QA site URL for direct access
      # url: http://your-qa-site.com  # OPTIONAL: Uncomment and set your live QA site URL for direct access
    
    # Write permission required to push merge and tags back to GitHub
    permissions:
      contents: write

    steps:
      - name: Checkout QA Branch
        uses: actions/checkout@v4
        with:
          ref: qa             # Always target QA branch explicitly
          fetch-depth: 0      # Fetch full history for tag calculation and merge operation

      - name: Setup Git User (For Merge)
        run: |
          git config --global user.name "CI/CD Bot"
          git config --global user.email "bot@ci-cd.com"

      # --- STEP 1: READ VERSION & CALCULATE BUILD NUMBER ---
      - name: Calculate Smart Version
        shell: powershell
        run: |
          # Read version from package.json
          $json = Get-Content 'package.json' -Raw | ConvertFrom-Json
          $appVer = $json.version
          
          Write-Host ">> Package Version: $appVer" -ForegroundColor Cyan
          
          # Find existing tags for this version
          git fetch --tags
          $prefix = "qa-v$appVer."
          $tagOutput = git tag -l "$prefix*"
          
          # Calculate next build number
          if ([string]::IsNullOrWhiteSpace($tagOutput)) {
            $buildNum = 1
          } else {
            # Split tags into array and extract numbers
            $tags = $tagOutput -split "`n" | Where-Object { $_ -ne "" }
            $maxNum = 0
            foreach ($tag in $tags) {
               $num = [int]($tag -replace $prefix, "")
               if ($num -gt $maxNum) { $maxNum = $num }
            }
            $buildNum = $maxNum + 1
          }
          
          # Construct final version tag (e.g., qa-v0.1.0.1)
          $fullVer = "$prefix$buildNum"
          
          Write-Host ">> Next Build Number: $buildNum" -ForegroundColor Green
          Write-Host ">> Final Tag: $fullVer" -ForegroundColor Green
          
          # Save to environment for next steps
          echo "FULL_VERSION=$fullVer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "APP_VERSION=$appVer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # --- STEP 2: CREATE AND AUTO-MERGE PR ---
      - name: Create Pull Request (DEV â†’ QA)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: powershell
        run: |
          Write-Host ">> Creating Pull Request from DEV to QA..." -ForegroundColor Cyan
          
          # Check if PR already exists
          $existingPR = gh pr list --base qa --head dev --state open --json number --jq '.[0].number'
          
          if ($existingPR) {
            Write-Host ">> PR #$existingPR already exists, using it..." -ForegroundColor Yellow
            echo "PR_NUMBER=$existingPR" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            # Create new PR
            $prNumber = gh pr create --base qa --head dev `
              --title "chore(qa): auto-merge [v$env:APP_VERSION]" `
              --body "Automated QA deployment from CI/CD workflow.`n`n**Version:** $env:FULL_VERSION`n**Triggered by:** @${{ github.actor }}" `
              --json number --jq '.number'
            
            if ($LASTEXITCODE -ne 0) {
              $err = "Failed to create PR. Check branch protection rules or GitHub CLI authentication."
              Write-Host "[!] $err" -ForegroundColor Red
              echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              exit 1
            }
            
            Write-Host ">> PR #$prNumber created successfully" -ForegroundColor Green
            echo "PR_NUMBER=$prNumber" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Auto-Merge Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        shell: powershell
        run: |
          Write-Host ">> Attempting to merge PR #$env:PR_NUMBER..." -ForegroundColor Cyan
          
          # Enable auto-merge (will merge when all checks pass and approvals are met)
          gh pr merge $env:PR_NUMBER --merge --auto
          
          if ($LASTEXITCODE -ne 0) {
            $err = "Failed to enable auto-merge for PR #$env:PR_NUMBER. Check for conflicts or approval requirements."
            Write-Host "[!] $err" -ForegroundColor Red
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }
          
          Write-Host "[OK] PR #$env:PR_NUMBER merge initiated!" -ForegroundColor Green
          Write-Host ">> If approval is required, an admin must approve the PR." -ForegroundColor Yellow

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      # --- STEP 3: DEPLOY ---
      # Install & Build is handled inside the deploy script on the server
      - name: Run Deploy Script
        shell: powershell
        run: |
          # QA branch is now updated, triggering deployment...
          ./scripts/deploy.ps1 -environment "QA"
          if ($LASTEXITCODE -ne 0) {
            $err = "Deploy script failed with exit code $LASTEXITCODE. Check deployment logs."
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

      # --- STEP 4: TAGGING (Smart Version) ---
      # Only create tag if deployment was successful
      - name: Create Git Tag
        if: success()
        shell: powershell
        run: |
          # Check if tag already exists
          $existingTag = git tag -l $env:FULL_VERSION
          if ($existingTag) {
            Write-Host "[!] Tag $env:FULL_VERSION already exists. Deployment succeeded but tag was already created." -ForegroundColor Yellow
            exit 0
          } else {
            git tag $env:FULL_VERSION
            git push origin $env:FULL_VERSION
            Write-Host "[OK] Tag Created and Pushed: $env:FULL_VERSION" -ForegroundColor Green
          }

      # --- STEP 5: SUMMARY ---
      # Always show summary, even if deployment failed
      - name: Add Job Summary
        if: always()
        shell: powershell
        run: |
          $status = if ("${{ job.status }}" -eq "success") { "SUCCESS" } else { "FAILED" }
          
          $msg = "### Deploy Summary`n"
          $msg += "* **Status:** $status`n"
          
          # Show error reason if failed
          if ($env:FAILURE_REASON) {
            $msg += "* **ERROR REASON:** $env:FAILURE_REASON`n"
          }
          
          $msg += "* **Environment:** QA`n"
          $msg += "* **Release Tag:** $($env:FULL_VERSION -replace '^$', 'N/A - Failed before tagging')`n"
          $msg += "* **App Version:** $($env:APP_VERSION -replace '^$', 'N/A')`n"
          $msg += "* **Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm')`n"
          
          echo $msg | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append