name: Rollback PROD

on:
  workflow_dispatch:
    inputs:
      rollback_mode:
        description: "Select Rollback Method"
        required: true
        default: "AUTO_PREVIOUS"
        type: choice
        options:
          - "AUTO_PREVIOUS (Revert to Last Working Version)"
          - "MANUAL_TAG (Enter Specific Tag)"

      manual_tag:
        description: "Manual Tag Name (e.g., prod-v0.1.0.5)"
        required: false
        type: string

      confirm_action:
        description: "CONFIRMATION: I confirm the PROD environment will be changed."
        required: true
        type: boolean
        default: false

# Shows rollback details in workflow name
run-name: Rollback PROD (${{ inputs.rollback_mode == 'MANUAL_TAG (Enter Specific Tag)' && inputs.manual_tag || inputs.rollback_mode }}) by @${{ github.actor }}

jobs:
  rollback:
    runs-on: [self-hosted, prod-server]

    environment:
      name: PROD

    permissions:
      contents: read

    steps:
      # --- STEP 1: SECURITY CHECK ---
      - name: Security Check and Confirmation
        shell: powershell
        run: |
          if ("${{ inputs.confirm_action }}" -ne "true") {
            $err = "User confirmation NOT checked. Please confirm the action."
            Write-Host "[!] $err" -ForegroundColor Red
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }
          Write-Host "[OK] User confirmation received. Starting rollback..." -ForegroundColor Green

      # --- STEP 2: CHECKOUT ---
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- STEP 3: DETERMINE ROLLBACK TARGET ---
      - name: Determine Rollback Target
        shell: powershell
        run: |
          $mode = "${{ inputs.rollback_mode }}"
          $manualInput = "${{ inputs.manual_tag }}"
          $targetTag = ""

          if ($mode -like "AUTO_PREVIOUS*") {
            Write-Host ">> Mode: AUTOMATIC (Finding previous working version...)" -ForegroundColor Cyan

            git fetch origin --tags

            # Sort all PROD tags by semantic version
            $allTags = git tag -l "prod-v*"
            if ([string]::IsNullOrWhiteSpace($allTags)) {
              $err = "No PROD tags found in repository. Deploy to PROD first."
              Write-Host "[!] $err" -ForegroundColor Red
              echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              exit 1
            }

            $tags = $allTags -split "`n" | Where-Object { $_ -ne "" } | Sort-Object {
              $parts = $_ -replace "^prod-v", "" -split "\."
              [int]$parts[0] * 1000000 + [int]$parts[1] * 10000 + [int]$parts[2] * 100 + [int]$parts[3]
            } -Descending

            # Need at least 2 tags (current + previous)
            if ($tags.Count -lt 2) {
               $err = "Insufficient PROD tags for auto-rollback. Need at least 2 deployments."
               Write-Host "[!] $err" -ForegroundColor Red
               echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
               exit 1
            }

            # 0: Current version, 1: Previous version
            $targetTag = $tags[1]
            Write-Host ">> Current Version: $($tags[0])" -ForegroundColor Gray
            Write-Host ">> Rolling back to: $targetTag" -ForegroundColor Yellow

          } else {
            Write-Host ">> Mode: MANUAL" -ForegroundColor Cyan

            if ([string]::IsNullOrWhiteSpace($manualInput)) {
              $err = "Manual mode selected but tag input is EMPTY. Please provide a tag name."
              Write-Host "[!] $err" -ForegroundColor Red
              echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              exit 1
            }

            # Check if tag exists
            git fetch origin --tags
            $tagExists = git tag -l $manualInput
            if ([string]::IsNullOrWhiteSpace($tagExists)) {
              $err = "Tag '$manualInput' does NOT exist in repository."
              Write-Host "[!] $err" -ForegroundColor Red
              echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              exit 1
            }

            $targetTag = $manualInput
            Write-Host ">> Manual tag validated: $targetTag" -ForegroundColor Green
          }

          echo "TARGET_TAG=$targetTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "FULL_VERSION=$targetTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # --- STEP 4: EXECUTE ROLLBACK ---
      - name: Checkout Target Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_TAG }}

      - name: Verify Checkout
        shell: powershell
        run: |
          $hash = git rev-parse HEAD
          $currentTag = git describe --tags --exact-match HEAD 2>$null
          Write-Host ">> Checked Out Tag: $env:TARGET_TAG" -ForegroundColor Green
          Write-Host ">> Commit Hash: $hash" -ForegroundColor Yellow
          if ($currentTag) {
            Write-Host ">> Tag Verification: PASSED" -ForegroundColor Green
          }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      # --- STEP 5: DEPLOY ---
      - name: Run Deploy Script
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          Write-Host "[!] EMERGENCY: Rolling back PROD to version '$env:TARGET_TAG'..." -ForegroundColor Red
          ./scripts/deploy.ps1 -environment "prod"
          if ($LASTEXITCODE -ne 0) {
            $err = "Rollback deploy failed with exit code $LASTEXITCODE. Check deployment logs above for details."
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

      # --- STEP 6: SUMMARY ---
      - name: Add Job Summary
        if: always()
        shell: powershell
        run: |
          $status = if ("${{ job.status }}" -eq "success") { "SUCCESS" } else { "FAILED" }

          $msg = "### Rollback Operation Log`n"
          $msg += "* **Status:** $status`n"

          if ($env:FAILURE_REASON) {
            $msg += "* **ERROR REASON:** $env:FAILURE_REASON`n"
          }

          $msg += "`n#### Rollback Target`n"
          $msg += "* **Restored to Version:** **$($env:TARGET_TAG -replace '^$', 'N/A - Failed before tag selection')**`n"
          $msg += "* **Mode:** ${{ inputs.rollback_mode }}`n"
          $msg += "* **Authorized By:** @${{ github.actor }}`n"
          $msg += "* **Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm')`n"
          $msg += "`n_Note: GitHub Environment shows this deployment in history. Current version on IIS is now **$env:TARGET_TAG**_`n"

          echo $msg | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
