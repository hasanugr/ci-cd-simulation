name: Deploy to PROD

# Shows who triggered the workflow
run-name: Deploy PROD by @${{ github.actor }}

# Manual trigger only
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, prod-server]

    # Track deployment history in PROD environment
    environment:
      name: PROD
      # url: https://site.com  # Optional: PROD site URL

    # Write permission to bypass branch protection
    permissions:
      contents: write

    steps:
      - name: Checkout MAIN Branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.BYPASS_TOKEN }}

      - name: Setup Git User (For Merge)
        run: |
          git config --global user.name "CI/CD Bot"
          git config --global user.email "bot@ci-cd.com"

      # --- STEP 1: READ VERSION FROM QA TAG ---
      - name: Get Version from QA
        shell: powershell
        run: |
          # Fetch all tags and QA branch
          git fetch origin qa --tags

          # Sort all QA tags by semantic version
          $allQaTags = git tag -l "qa-v*" | Sort-Object {
            $parts = $_ -replace "^qa-v", "" -split "\."
            [int]$parts[0] * 1000000 + [int]$parts[1] * 10000 + [int]$parts[2] * 100 + [int]$parts[3]
          } -Descending

          if ($allQaTags.Count -eq 0) {
            $err = "No QA tag found. Please deploy to QA environment first."
            Write-Host "[!] $err" -ForegroundColor Red
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

          # Get the latest QA tag
          $qaTag = $allQaTags[0]
          Write-Host ">> Latest QA Tag: $qaTag" -ForegroundColor Cyan

          # Convert to PROD tag (qa-v0.1.0.1 -> prod-v0.1.0.1)
          $prodTag = $qaTag -replace "^qa-", "prod-"

          # Extract app version (qa-v0.1.0.1 -> 0.1.0)
          $appVer = $qaTag -replace "^qa-v", "" -replace "\.\d+$", ""

          Write-Host ">> Target PROD Tag: $prodTag" -ForegroundColor Green
          Write-Host ">> App Version: $appVer" -ForegroundColor Green

          echo "FULL_VERSION=$prodTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "APP_VERSION=$appVer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "QA_TAG=$qaTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # --- STEP 2: MERGE (QA -> MAIN) ---
      - name: Merge QA into MAIN
        shell: powershell
        run: |
          Write-Host ">> Merging QA into MAIN..." -ForegroundColor Cyan
          git fetch origin qa

          $runNum = "${{ github.run_number }}"
          $commitMsg = "ci(prod): QA -> PROD automated release [$env:FULL_VERSION] from $env:QA_TAG - GitHub Actions Run #$runNum"
          git merge origin/qa --allow-unrelated-histories --no-edit -m "$commitMsg"

          # Check for merge conflicts
          $conflictFiles = git diff --name-only --diff-filter=U
          if ($conflictFiles) {
            $err = "Merge conflict detected. Conflicting files: $conflictFiles"
            Write-Host "[!] MERGE CONFLICT DETECTED!" -ForegroundColor Red
            Write-Host "Conflicting files:" -ForegroundColor Yellow
            Write-Host $conflictFiles
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

          git push origin main
          Write-Host "[OK] Merge Success (QA -> MAIN)!" -ForegroundColor Green

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      # --- STEP 3: DEPLOY ---
      - name: Run Deploy Script
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          ./scripts/deploy.ps1 -environment "prod"
          if ($LASTEXITCODE -ne 0) {
            $err = "Deploy script failed with exit code $LASTEXITCODE. Check deployment logs above for details."
            echo "FAILURE_REASON=$err" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            exit 1
          }

      # --- STEP 4: TAGGING ---
      - name: Create Git Tag
        if: success()
        shell: powershell
        run: |
          $existingTag = git tag -l $env:FULL_VERSION
          if ($existingTag) {
            Write-Host "[!] Tag $env:FULL_VERSION already exists." -ForegroundColor Yellow
            exit 0
          } else {
            git tag $env:FULL_VERSION
            git push origin $env:FULL_VERSION
            Write-Host "[OK] Tag Created and Pushed: $env:FULL_VERSION" -ForegroundColor Green
          }

      # --- STEP 5: SUMMARY ---
      - name: Add Job Summary
        if: always()
        shell: powershell
        run: |
          $status = if ("${{ job.status }}" -eq "success") { "SUCCESS" } else { "FAILED" }

          $msg = "### Deploy Summary`n"
          $msg += "* **Status:** $status`n"

          if ($env:FAILURE_REASON) {
            $msg += "* **ERROR REASON:** $env:FAILURE_REASON`n"
          }

          $msg += "* **Environment:** PROD`n"
          $msg += "* **Source QA Tag:** $($env:QA_TAG -replace '^$', 'N/A')`n"
          $msg += "* **PROD Release Tag:** $($env:FULL_VERSION -replace '^$', 'N/A - Failed before tagging')`n"
          $msg += "* **App Version:** $($env:APP_VERSION -replace '^$', 'N/A')`n"
          $msg += "* **Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm')`n"

          echo $msg | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
